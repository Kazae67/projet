{% extends 'base.html.twig' %}

{% block title %}{{ product.name }} - Product Details{% endblock %}

{% block body %}
    <div class="parent-container">
        <div class="demi-cercle"></div>
        <div class="form-container">
            <header>
                <h1>{{ product.name }}</h1>
            </header>

            <article class="page-layout">
                <div class="product-info">
                    <!-- IMAGE -->
                    <div class="image-container">
                        <img src="{{ product.imageUrl ?: '/images/default-image.jpg' }}" alt="Image of {{ product.name }}" class="product-img">
                    </div>
                    
                    <!-- CATEGORIE -->
                    <section>
                        <h2>Category</h2>
                        <p>{{ product.category.name }}</p>
                    </section>

                    <!-- DESCRIPTION -->
                    <section>
                        <h2>Description</h2>
                        <p>{{ product.description }}</p>
                    </section>

                    <!-- PRIX ET STOCK -->
                    <section>
                        <h2>Price and Stock</h2>
                        <p><strong>Price:</strong> {{ product.price }}€</p>
                        <p><strong>Quantity in stock:</strong> {{ product.stockQuantity }}</p>
                    </section>

                    <!-- DATES -->
                    <section>
                        <h2>Dates</h2>
                        <p><strong>Date of creation:</strong> {{ product.createdAt ? product.createdAt|date('d-m-Y H:i') : 'Not specified.' }}</p>
                        <p><strong>Update date:</strong> {{ product.updatedAt ? product.updatedAt|date('d-m-Y H:i') : 'Not specified.' }}</p>
                    </section>
                </div>

                <!-- Affichage des revues existantes -->
                <div class="product-reviews">
                    <!-- Afficher le formulaire de revue uniquement si l'utilisateur peut laisser un avis et n'est pas le propriétaire du produit -->
                    {% if canReview and app.user != product.user %}
                        <div id="review-form-container" style="display:none;">
                            {% include 'review/add.html.twig' with {'form': form} %}
                        </div>
                        <button id="add-review-button" class="btn btn-primary">Add a review</button>
                    {% elseif existingReview %}
                        <p>Thank you for your review!</p>
                    {% endif %}

                    <!-- Affichage des revues existantes -->
                    <h3>Review</h3>
                    {% for review in reviews %}
                        <div class="review" id="review-{{ review.id }}">
                            <!-- USERNAME -->
                            <p><strong>Username:</strong> {{ review.user.username }}</p>
                            <!-- TITRE -->
                            <p id="review-title-{{ review.id }}"><strong>Title:</strong> {{ review.title }}</p>
                            <!-- RATING  -->
                            <div class="rating" id="review-rating-{{ review.id }}" data-rating="{{ review.rating }}">
                                {% for i in 1..5 %}
                                    {% if i <= review.rating %}
                                        <span class="fa fa-star checked"></span>
                                    {% else %}
                                        <span class="fa fa-star"></span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <!-- COMMENT -->
                            <div id="review-comment-{{ review.id }}">{{ review.comment }}</div>
                            <!-- Si l'utilisateur est le propriétaire du review -->
                            {% if app.user and app.user == review.user %}
                                <button class="btn btn-edit" onclick="editReview({{ review.id }})">Edit</button>
                                <a href="{{ path('review_delete', {'id': review.id}) }}" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this review ?');">Delete</a>
                                <div id="edit-review-form-{{ review.id }}" style="display:none;">
                                    <input type="text" id="edit-title-{{ review.id }}" class="form-control" value="{{ review.title }}">
                                    <select id="edit-rating-{{ review.id }}" class="form-control">
                                        {% for i in 1..5 %}
                                            <option value="{{ i }}" {{ review.rating == i ? 'selected' : '' }}>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                    <textarea id="edit-comment-{{ review.id }}" class="form-control">{{ review.comment }}</textarea>
                                    <!-- Bouton UPDATE -->
                                    <button onclick="submitReviewEditForm(event, {{ review.id }})" class="btn btn-update">Update</button>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <p>No review for this product.</p>
                    {% endfor %}
                </div>
            </article>

            <!-- Retour à la liste -->
            <a href="{{ path('product') }}" class="back-link">Back to product list</a>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/edit-review.js') }}"></script>
{% endblock %}
